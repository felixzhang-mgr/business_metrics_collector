# Oracle指标采集配置文件

# 数据库连接配置
# 注意：数据库连接信息（username, password, host, port, service_name）必须通过环境变量设置
# 请在运行前设置以下环境变量：
#   ORACLE_USERNAME, ORACLE_PASSWORD, ORACLE_HOST, ORACLE_PORT, ORACLE_SERVICE
database:
  max_connections: 10  # 最大连接数
  default_query_timeout: 30.0  # 默认查询超时时间（秒）

# 公共维度（所有指标共享）
common_dimensions:
  - Name: team
    Value: maintenance

# 指标配置列表
metrics:
  # EC2OracleAlive指标：检查数据库存活性
  - metric_name: EC2OracleAlive
    sql_query: SELECT 1 FROM DUAL
    namespace: Paytend_Production
    dimensions: 
      - Name: InstanceId
        Value: i-00c75580acea9167d
    converter:
      type: simple
      func: "lambda x: 1.0 if x is not None else 0.0"
    unit: None
    cron: "*/1 * * * *"  # 每分钟执行一次
    # query_timeout: 10  # 查询超时时间（秒），可选，不设置则使用默认值30秒

  # 每小时卡授权交易笔数（固定窗口）：每小时整点执行，统计上一个完整小时的交易笔数，按RESPONSECODE分组
  - metric_name: HourlyTransactionCount
    sql_query: |
      SELECT RESPONSECODE, COUNT(*) 
      FROM PAYTEND.TBL_TRIBECARDAUTHORIZATION 
      WHERE CREATETIME >= TRUNC(SYSDATE, 'HH24') - INTERVAL '1' HOUR
        AND CREATETIME < TRUNC(SYSDATE, 'HH24')
      GROUP BY RESPONSECODE
    namespace: Paytend_Production
    dimensions: 
      - Name: team
        Value: Paytend
      - Name: business
        Value: TribeCardAuthorization
    multi_row: true  # 启用多行结果模式，每行按RESPONSECODE分组
    dynamic_dimensions:
      - column: RESPONSECODE  # 第一列（RESPONSECODE）
        dimension_name: ResponseCode  # CloudWatch维度名称
    unit: Count  # Transactions Per Hour
    cron: "0 * * * *"  # 每小时整点执行一次
    # query_timeout: 30  # 查询超时时间（秒），可选

  # 超时卡授权交易监控（滑动窗口）：每5分钟执行一次，查询过去1小时的超时交易数，用于实时告警
  - metric_name: TimeoutTransactionCount
    sql_query: |
      SELECT COUNT(*) 
      FROM PAYTEND.TBL_TRIBECARDAUTHORIZATION 
      WHERE RESPONSECODE = '05' 
        AND NOTE = 'TAI request timeout' 
        AND CREATETIME >= SYSDATE - INTERVAL '60' MINUTE
    namespace: Paytend_Production
    dimensions: 
      - Name: team
        Value: Paytend
      - Name: business
        Value: TribeCardAuthorization
    unit: Count
    cron: "*/5 * * * *"  # 每5分钟执行一次，用于及时告警
    # query_timeout: 30  # 查询超时时间（秒），可选
    # 告警建议：在Grafana中设置告警规则，当值 > 5 时触发告警

  # 卡授权交易异常监控（滑动窗口）：每5分钟执行一次，查询过去1小时的交易异常数，用于实时告警
  - metric_name: AbnormalTransactionCount
    sql_query: |
      SELECT COUNT(*) 
      FROM PAYTEND.TBL_TRIBECARDAUTHORIZATION 
      WHERE RESPONSECODE = '05' 
        AND CREATETIME >= SYSDATE - INTERVAL '60' MINUTE
    namespace: Paytend_Production
    dimensions: 
      - Name: team
        Value: Paytend
      - Name: business
        Value: TribeCardAuthorization
    unit: Count
    cron: "*/5 * * * *"  # 每5分钟执行一次，用于及时告警
    # 告警建议：在Grafana中设置告警规则，当值 > 5 时触发告警

  # 示例：多行结果和动态维度 - 按RESPONSECODE分组统计交易数
  # - metric_name: TransactionCountByResponseCode
  #   sql_query: |
  #     SELECT RESPONSECODE, COUNT(*) 
  #     FROM PAYTEND.TBL_TRIBECARDAUTHORIZATION 
  #     WHERE CREATETIME >= SYSDATE - INTERVAL '60' MINUTE
  #     GROUP BY RESPONSECODE
  #   namespace: Paytend_Production
  #   dimensions: 
  #     - Name: team
  #       Value: Paytend
  #     - Name: business
  #       Value: TribeCardAuthorization
  #   multi_row: true  # 启用多行结果模式
  #   dynamic_dimensions:
  #     - column: 0  # 第一列（RESPONSECODE），也可以使用列名 "RESPONSECODE"
  #       dimension_name: ResponseCode  # CloudWatch维度名称
  #   converter: null
  #   unit: Count
  #   cron: "*/5 * * * *"  # 每5分钟执行一次
  #   说明：
  #     - 查询返回多行，每行包含 RESPONSECODE 和 COUNT(*)
  #     - 每行会发送一个独立的指标，维度中包含 ResponseCode=对应的值
  #     - 例如：如果查询返回 ('05', 10) 和 ('06', 5)，会发送两个指标：
  #       * TransactionCountByResponseCode, ResponseCode=05, Value=10
  #       * TransactionCountByResponseCode, ResponseCode=06, Value=5

  # 示例：简单指标（直接使用SQL查询结果）
  # - metric_name: OracleActiveConnections
  #   sql_query: SELECT COUNT(*) FROM v$session WHERE status = 'ACTIVE'
  #   namespace: Paytend_Production
  #   dimensions: [] # 使用公共维度
  #   converter: null
  #   unit: Count
  #   cron: "*/5 * * * *"  # 每5分钟执行一次
  #   query_timeout: 15  # 此查询最多等待15秒

  # 示例：使用平均值转换器
  # - metric_name: OracleAvgResponseTime
  #   sql_query: SELECT AVG(response_time) FROM performance_log
  #   namespace: Paytend_Production
  #   dimensions: []
  #   converter:
  #     type: avg
  #     max_history_size: 10
  #   unit: Milliseconds
  #   cron: "*/2 * * * *"  # 每2分钟执行一次

  # 示例：使用速率转换器
  # - metric_name: OracleTransactionRate
  #   sql_query: SELECT transaction_count FROM stats_table
  #   namespace: Paytend_Production
  #   dimensions: []
  #   converter:
  #     type: rate
  #   unit: Count/Second
  #   cron: "*/1 * * * *"  # 每分钟执行一次

  # 示例：使用增量转换器
  # - metric_name: OracleTotalTransactions
  #   sql_query: SELECT transaction_count FROM stats_table
  #   namespace: Paytend_Production
  #   dimensions: []
  #   converter:
  #     type: increase
  #   unit: Count
  #   cron: "*/1 * * * *"  # 每分钟执行一次

  # 示例：使用最大值转换器
  # - metric_name: OracleMaxConnections
  #   sql_query: SELECT current_connections FROM stats_table
  #   namespace: Paytend_Production
  #   dimensions: []
  #   converter:
  #     type: max
  #     max_history_size: 60
  #   unit: Count
  #   cron: "0 * * * *"  # 每小时执行一次

  # 示例：复杂SQL查询 - 多表JOIN
  # - metric_name: OracleComplexQuery
  #   sql_query: |
  #     SELECT 
  #       COUNT(DISTINCT s.sid) as active_sessions,
  #       SUM(CASE WHEN s.status = 'ACTIVE' THEN 1 ELSE 0 END) as active_count
  #     FROM v$session s
  #     JOIN v$process p ON s.paddr = p.addr
  #     WHERE s.username IS NOT NULL
  #       AND s.type = 'USER'
  #   namespace: Paytend_Production
  #   dimensions: []
  #   converter: null
  #   unit: Count
  #   cron: "*/5 * * * *"  # 每5分钟执行一次
  #   query_timeout: 30

  # 示例：复杂SQL查询 - 子查询和聚合
  # - metric_name: OracleTableSpaceUsage
  #   sql_query: |
  #     SELECT 
  #       ROUND(
  #         (SELECT SUM(bytes) FROM dba_data_files WHERE tablespace_name = 'USERS') / 
  #         (SELECT SUM(bytes) FROM dba_data_files WHERE tablespace_name = 'USERS') * 100,
  #         2
  #       ) as usage_percent
  #     FROM dual
  #   namespace: Paytend_Production
  #   dimensions: []
  #   converter: null
  #   unit: Percent
  #   cron: "*/10 * * * *"  # 每10分钟执行一次

  # 示例：复杂SQL查询 - 窗口函数
  # - metric_name: OracleTopWaitEvents
  #   sql_query: |
  #     SELECT 
  #       event,
  #       total_waits,
  #       time_waited
  #     FROM (
  #       SELECT 
  #         event,
  #         total_waits,
  #         time_waited,
  #         ROW_NUMBER() OVER (ORDER BY time_waited DESC) as rn
  #       FROM v$system_event
  #       WHERE wait_class != 'Idle'
  #     )
  #     WHERE rn = 1
  #   namespace: Paytend_Production
  #   dimensions: []
  #   converter: null
  #   unit: Count
  #   cron: "*/15 * * * *"  # 每15分钟执行一次

  # 示例：复杂SQL查询 - CASE WHEN条件判断
  # - metric_name: OracleDatabaseStatus
  #   sql_query: |
  #     SELECT 
  #       CASE 
  #         WHEN open_mode = 'READ WRITE' THEN 1
  #         WHEN open_mode = 'READ ONLY' THEN 0.5
  #         ELSE 0
  #       END as status_value
  #     FROM v$database
  #   namespace: Paytend_Production
  #   dimensions: []
  #   converter: null
  #   unit: None
  #   cron: "*/1 * * * *"  # 每分钟执行一次

  # 示例：复杂SQL查询 - 多条件WHERE和GROUP BY
  # - metric_name: OracleSessionByStatus
  #   sql_query: |
  #     SELECT 
  #       status,
  #       COUNT(*) as session_count
  #     FROM v$session
  #     WHERE username IS NOT NULL
  #       AND type = 'USER'
  #       AND status IN ('ACTIVE', 'INACTIVE')
  #     GROUP BY status
  #     HAVING COUNT(*) > 0
  #   namespace: Paytend_Production
  #   dimensions: []
  #   converter: null
  #   unit: Count
  #   cron: "*/3 * * * *"  # 每3分钟执行一次
  #   query_timeout: 20
